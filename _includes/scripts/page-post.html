{%- include snippets/get-sources.html -%}
{%- assign _sources = __return -%}
<script>
  (function() {
    function scrollAnimateTo(destination, duration, callback) {
      var $body = $('html, body'), bodyScrollTop = $body.scrollTop();
      if(bodyScrollTop === destination) { return; }
      $body.animate({ scrollTop: destination }, duration, callback);
    }
    window.scrollTopAnchor = function(anchor, callback) {
      scrollAnimateTo($(anchor).offset().top, 400, function() {
        window.history.replaceState(null, '', window.location.href.split('#')[0] + anchor);
        callback && callback();
      });
    }
  })();
  window.Lazyload.js('{{ _sources.jquery }}', function() {
    var $articleContent = $('.m-post, .m-page').find('.m-article-content'), $this;
    $articleContent.children('.highlight').each(function() {
      $this = $(this);
      $this.attr('data-lang', $this.find('code').attr('data-lang'));
    });

    $articleContent.children('h1, h2, h3, h4, h5, h6').each(function() {
      $this = $(this);
      $this.append($('<a class="anchor" aria-hidden="true"></a>').html('{%- include icon/link.svg -%}'));
    });
    $articleContent.on('click', '.anchor', function() {
      window.scrollTopAnchor('#' + $(this).parent().attr('id'));
    });
  });
</script>

<!--{%- if site.leancloud.app_id and site.leancloud.app_key and site.leancloud.app_class -%}-->
<!--{%- assign _sources = __return -%}-->
<!--<script>-->
  <!--window.Lazyload.js(['{{ _sources.jquery }}', '{{ _sources.leancloud_js_sdk }}'], function() {-->
    <!--AV.init({-->
      <!--appId: '{{ site.leancloud.app_id }}',-->
      <!--appKey: '{{ site.leancloud.app_key }}'-->
    <!--});-->
    <!--$(".article-view").each(function() {-->
      <!--var curId = this.id;-->
      <!--var query = new AV.Query('{{ site.leancloud.app_class }}');-->
      <!--query.equalTo('key', curId.substr(9));-->
      <!--query.first().then(function(result) {-->
        <!--if (result) {-->
          <!--$('#' + curId).text(result.attributes.views);-->
        <!--}-->
      <!--}, function(error) {-->
        <!--if (error) {-->
          <!--throw error;-->
        <!--}-->
      <!--});-->
    <!--});-->
  <!--});-->
<!--</script>-->
<!--{%- endif -%}-->
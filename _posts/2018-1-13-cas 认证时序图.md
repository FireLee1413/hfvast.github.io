---
layout: post
date: 2018-01-13 20:26:11
title: cas认证时序图
key: cas认证时序图
tags: cas
---

### 名次解释

|名词|解释|
--|--
brower|用户的浏览器|
tomcat|业务所在的web服务器|
cas|cas服务器|
service参数|业务方的访问地址,即tomcat的访问地址,在集群中应该是nginx的对外地址,最终应该是用户浏览器访问业务的地址|
tgt|cas服务器根据账号的用户名密码等信息进行加密生成的凭证,单机随cas应用存储在同一个jvm中,集群应该存储在redis,memcached等高性能分布式存储系统中.一个用户对应一个tgt|
tgc|可以理解为tgt的index,即tgt得主键,存储在用户浏览器的cookie中.随用户登录而生成,随用户注销而删除(还有cookie过期时间)
location|重定向|
st令牌|根据tgt生成的一次性的访问令牌,业务方发送st令牌和service参数访问cas服务端进行校验|
spring security|spring 家族的一款权限管理组件,基于servlet规范,类似的有apache 的shiro.都只能很好的进行垂直权限管理|

<h3 id="用户第一次登录">用户第一次登录</h3>
<div class="mermaid"><svg xmlns="http://www.w3.org/2000/svg" id="mermaid-svg-4ZI7kiYi3OFVq8hP" height="100%" width="100%" style="max-width:650px;" viewBox="-50 -10 650 957"><g></g><g><line id="actor110" x1="75" y1="5" x2="75" y2="946" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="0" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="75" y="32.5" style="text-anchor: middle;" dominant-baseline="central" alignment-baseline="central" class="actor"><tspan x="75" dy="0">brower</tspan></text></g><g><line id="actor111" x1="275" y1="5" x2="275" y2="946" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="200" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="275" y="32.5" style="text-anchor: middle;" dominant-baseline="central" alignment-baseline="central" class="actor"><tspan x="275" dy="0">tomcat</tspan></text></g><g><line id="actor112" x1="475" y1="5" x2="475" y2="946" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="400" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="475" y="32.5" style="text-anchor: middle;" dominant-baseline="central" alignment-baseline="central" class="actor"><tspan x="475" dy="0">cas</tspan></text></g><defs><marker id="arrowhead" refX="5" refY="2" markerWidth="6" markerHeight="4" orient="auto"><path d="M 0,0 V 4 L6,2 Z"></path></marker></defs><defs><marker id="crosshead" markerWidth="15" markerHeight="8" orient="auto" refX="16" refY="4"><path fill="black" stroke="#000000" stroke-width="1px" d="M 9,2 V 6 L16,4 Z" style="stroke-dasharray: 0, 0;"></path><path fill="none" stroke="#000000" stroke-width="1px" d="M 0,1 L 6,7 M 6,1 L 0,7" style="stroke-dasharray: 0, 0;"></path></marker></defs><g><text x="175" y="93" class="messageText" style="text-anchor: middle;">发起登录请求</text><line x1="75" y1="100" x2="275" y2="100" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><rect x="200" y="110" fill="#EDF2AE" stroke="#666" width="150" height="80" rx="0" ry="0" class="note"></rect><text x="216" y="140" fill="black" class="noteText"><tspan x="216">本地未登录,通知r</tspan><tspan dy="23" x="216">edirect,附</tspan><tspan dy="23" x="216">带service参数</tspan></text></g><g><text x="175" y="218" class="messageText" style="text-anchor: middle;">location</text><line x1="275" y1="225" x2="75" y2="225" class="messageLine1" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="stroke-dasharray: 3, 3; fill: none;"></line></g><g><text x="275" y="253" class="messageText" style="text-anchor: middle;">访问统一认证</text><line x1="75" y1="260" x2="475" y2="260" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><rect x="400" y="270" fill="#EDF2AE" stroke="#666" width="150" height="34" rx="0" ry="0" class="note"></rect><text x="416" y="300" fill="black" class="noteText"><tspan x="416" fill="black">当前用户未登录</tspan></text></g><g><text x="275" y="332" class="messageText" style="text-anchor: middle;">返回登录页面</text><line x1="475" y1="339" x2="75" y2="339" class="messageLine1" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="stroke-dasharray: 3, 3; fill: none;"></line></g><g><rect x="0" y="349" fill="#EDF2AE" stroke="#666" width="150" height="34" rx="0" ry="0" class="note"></rect><text x="16" y="379" fill="black" class="noteText"><tspan x="16" fill="black">用户输入账号,密码</tspan></text></g><g><text x="275" y="411" class="messageText" style="text-anchor: middle;">认证</text><line x1="75" y1="418" x2="475" y2="418" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><rect x="400" y="428" fill="#EDF2AE" stroke="#666" width="150" height="80" rx="0" ry="0" class="note"></rect><text x="416" y="458" fill="black" class="noteText"><tspan x="416">认证通过,生成tgt令牌</tspan><tspan dy="23" x="416">,写入tgc,通知red</tspan><tspan dy="23" x="416">irect,附带st令牌</tspan></text></g><g><text x="275" y="536" class="messageText" style="text-anchor: middle;">location</text><line x1="475" y1="543" x2="75" y2="543" class="messageLine1" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="stroke-dasharray: 3, 3; fill: none;"></line></g><g><text x="175" y="571" class="messageText" style="text-anchor: middle;">重新访问tomcat</text><line x1="75" y1="578" x2="275" y2="578" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><rect x="200" y="588" fill="#EDF2AE" stroke="#666" width="150" height="34" rx="0" ry="0" class="note"></rect><text x="216" y="618" fill="black" class="noteText"><tspan x="216" fill="black">检测到有st令牌.</tspan></text></g><g><text x="375" y="650" class="messageText" style="text-anchor: middle;">发送st令牌和service参数进行验证</text><line x1="275" y1="657" x2="475" y2="657" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><rect x="400" y="667" fill="#EDF2AE" stroke="#666" width="150" height="34" rx="0" ry="0" class="note"></rect><text x="416" y="697" fill="black" class="noteText"><tspan x="416" fill="black">进行验证</tspan></text></g><g><text x="375" y="729" class="messageText" style="text-anchor: middle;">返回登录用户名</text><line x1="475" y1="736" x2="275" y2="736" class="messageLine1" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="stroke-dasharray: 3, 3; fill: none;"></line></g><g><rect x="200" y="746" fill="#EDF2AE" stroke="#666" width="150" height="80" rx="0" ry="0" class="note"></rect><text x="216" y="776" fill="black" class="noteText"><tspan x="216">本地进行用户的</tspan><tspan dy="23" x="216">认证和授权,写</tspan><tspan dy="23" x="216">入session</tspan></text></g><g><text x="175" y="854" class="messageText" style="text-anchor: middle;">返回允许的资源</text><line x1="275" y1="861" x2="75" y2="861" class="messageLine1" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="stroke-dasharray: 3, 3; fill: none;"></line></g><g><rect x="0" y="881" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="75" y="913.5" style="text-anchor: middle;" dominant-baseline="central" alignment-baseline="central" class="actor"><tspan x="75" dy="0">brower</tspan></text></g><g><rect x="200" y="881" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="275" y="913.5" style="text-anchor: middle;" dominant-baseline="central" alignment-baseline="central" class="actor"><tspan x="275" dy="0">tomcat</tspan></text></g><g><rect x="400" y="881" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="475" y="913.5" style="text-anchor: middle;" dominant-baseline="central" alignment-baseline="central" class="actor"><tspan x="475" dy="0">cas</tspan></text></g></svg></div>
<h3 id="第二次登录">第二次登录</h3>
<div class="mermaid"><svg xmlns="http://www.w3.org/2000/svg" id="mermaid-svg-QCILH6jeTMjIvXH4" height="100%" width="100%" style="max-width:450px;" viewBox="-50 -10 450 275"><g></g><g><line id="actor113" x1="75" y1="5" x2="75" y2="264" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="0" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="75" y="32.5" style="text-anchor: middle;" dominant-baseline="central" alignment-baseline="central" class="actor"><tspan x="75" dy="0">brower</tspan></text></g><g><line id="actor114" x1="275" y1="5" x2="275" y2="264" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="200" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="275" y="32.5" style="text-anchor: middle;" dominant-baseline="central" alignment-baseline="central" class="actor"><tspan x="275" dy="0">tomcat</tspan></text></g><defs><marker id="arrowhead" refX="5" refY="2" markerWidth="6" markerHeight="4" orient="auto"><path d="M 0,0 V 4 L6,2 Z"></path></marker></defs><defs><marker id="crosshead" markerWidth="15" markerHeight="8" orient="auto" refX="16" refY="4"><path fill="black" stroke="#000000" stroke-width="1px" d="M 9,2 V 6 L16,4 Z" style="stroke-dasharray: 0, 0;"></path><path fill="none" stroke="#000000" stroke-width="1px" d="M 0,1 L 6,7 M 6,1 L 0,7" style="stroke-dasharray: 0, 0;"></path></marker></defs><g><text x="175" y="93" class="messageText" style="text-anchor: middle;">发起登录请求</text><line x1="75" y1="100" x2="275" y2="100" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><rect x="200" y="110" fill="#EDF2AE" stroke="#666" width="150" height="34" rx="0" ry="0" class="note"></rect><text x="216" y="140" fill="black" class="noteText"><tspan x="216" fill="black">本地已登录</tspan></text></g><g><text x="175" y="172" class="messageText" style="text-anchor: middle;">返回允许的资源</text><line x1="275" y1="179" x2="75" y2="179" class="messageLine1" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="stroke-dasharray: 3, 3; fill: none;"></line></g><g><rect x="0" y="199" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="75" y="231.5" style="text-anchor: middle;" dominant-baseline="central" alignment-baseline="central" class="actor"><tspan x="75" dy="0">brower</tspan></text></g><g><rect x="200" y="199" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="275" y="231.5" style="text-anchor: middle;" dominant-baseline="central" alignment-baseline="central" class="actor"><tspan x="275" dy="0">tomcat</tspan></text></g></svg></div>
<h3 id="用户注销登录">用户注销登录</h3>
<div class="mermaid"><svg xmlns="http://www.w3.org/2000/svg" id="mermaid-svg-3QtWFyvH1AOaVEMI" height="100%" width="100%" style="max-width:650px;" viewBox="-50 -10 650 505"><g></g><g><line id="actor115" x1="75" y1="5" x2="75" y2="494" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="0" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="75" y="32.5" style="text-anchor: middle;" dominant-baseline="central" alignment-baseline="central" class="actor"><tspan x="75" dy="0">brower</tspan></text></g><g><line id="actor116" x1="275" y1="5" x2="275" y2="494" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="200" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="275" y="32.5" style="text-anchor: middle;" dominant-baseline="central" alignment-baseline="central" class="actor"><tspan x="275" dy="0">tomcat</tspan></text></g><g><line id="actor117" x1="475" y1="5" x2="475" y2="494" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="400" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="475" y="32.5" style="text-anchor: middle;" dominant-baseline="central" alignment-baseline="central" class="actor"><tspan x="475" dy="0">cas</tspan></text></g><defs><marker id="arrowhead" refX="5" refY="2" markerWidth="6" markerHeight="4" orient="auto"><path d="M 0,0 V 4 L6,2 Z"></path></marker></defs><defs><marker id="crosshead" markerWidth="15" markerHeight="8" orient="auto" refX="16" refY="4"><path fill="black" stroke="#000000" stroke-width="1px" d="M 9,2 V 6 L16,4 Z" style="stroke-dasharray: 0, 0;"></path><path fill="none" stroke="#000000" stroke-width="1px" d="M 0,1 L 6,7 M 6,1 L 0,7" style="stroke-dasharray: 0, 0;"></path></marker></defs><g><text x="175" y="93" class="messageText" style="text-anchor: middle;">发起注销登录请求</text><line x1="75" y1="100" x2="275" y2="100" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><rect x="200" y="110" fill="#EDF2AE" stroke="#666" width="150" height="80" rx="0" ry="0" class="note"></rect><text x="216" y="140" fill="black" class="noteText"><tspan x="216">本地spring</tspan><tspan dy="23" x="216">security注销,redirect到cas</tspan><tspan dy="23" x="216">server,附带service参数</tspan></text></g><g><text x="175" y="218" class="messageText" style="text-anchor: middle;">location</text><line x1="275" y1="225" x2="75" y2="225" class="messageLine1" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="stroke-dasharray: 3, 3; fill: none;"></line></g><g><text x="275" y="253" class="messageText" style="text-anchor: middle;">cas注销请求</text><line x1="75" y1="260" x2="475" y2="260" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><rect x="400" y="270" fill="#EDF2AE" stroke="#666" width="150" height="34" rx="0" ry="0" class="note"></rect><text x="416" y="300" fill="black" class="noteText"><tspan x="416" fill="black">删除tgt,tgc.</tspan></text></g><g><text x="375" y="332" class="messageText" style="text-anchor: middle;">循环通知每一个tomcat进行注销</text><line x1="475" y1="339" x2="275" y2="339" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><text x="375" y="367" class="messageText" style="text-anchor: middle;">注销成功</text><line x1="275" y1="374" x2="475" y2="374" class="messageLine1" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="stroke-dasharray: 3, 3; fill: none;"></line></g><g><text x="275" y="402" class="messageText" style="text-anchor: middle;">通知用户注销成功,重定向到登录页面.</text><line x1="475" y1="409" x2="75" y2="409" class="messageLine1" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="stroke-dasharray: 3, 3; fill: none;"></line></g><g><rect x="0" y="429" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="75" y="461.5" style="text-anchor: middle;" dominant-baseline="central" alignment-baseline="central" class="actor"><tspan x="75" dy="0">brower</tspan></text></g><g><rect x="200" y="429" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="275" y="461.5" style="text-anchor: middle;" dominant-baseline="central" alignment-baseline="central" class="actor"><tspan x="275" dy="0">tomcat</tspan></text></g><g><rect x="400" y="429" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="475" y="461.5" style="text-anchor: middle;" dominant-baseline="central" alignment-baseline="central" class="actor"><tspan x="475" dy="0">cas</tspan></text></g></svg></div>

